name: Deploy Dependency Scan App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.EC2_PUBLIC_IP }}" >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          set -e

          echo "âœ… Checking system resources before deployment..."
          free -m
          df -h
          top -b -n 1 | head -20

          if [ ! -d "/home/ec2-user/demo" ]; then
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/yagneshnj/demo.git /home/ec2-user/demo
          else
            echo "ğŸ“¥ Pulling latest changes..."
            cd /home/ec2-user/demo
            git reset --hard
            git clean -xfd
            git pull origin main
          fi

          cd /home/ec2-user/demo

          echo "âš™ï¸ Setting environment variables..."
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
          echo "DEPLOY_GITHUB_TOKEN=${{ secrets.DEPLOY_GITHUB_TOKEN }}" >> .env
          echo "DEPLOY_GITHUB_APP_ID=${{ secrets.DEPLOY_GITHUB_APP_ID }}" >> .env
          echo "DEPLOY_GITHUB_APP_SLUG=${{ secrets.DEPLOY_GITHUB_APP_SLUG }}" >> .env
          echo "DEPLOY_GITHUB_WEBHOOK_SECRET=${{ secrets.DEPLOY_GITHUB_WEBHOOK_SECRET }}" >> .env
          echo "DEPLOY_GITHUB_PRIVATE_KEY='${{ secrets.DEPLOY_GITHUB_PRIVATE_KEY }}'" >> .env

          echo "ğŸ›‘ Stopping old container if exists..."
          docker stop dependency-scan-container || true
          docker rm dependency-scan-container || true

          echo "ğŸ§¹ Cleaning up Docker images..."
          docker image prune -af || true

          echo "ğŸ³ Building new Docker image..."
          docker build -t dependency-scan-app .

          echo "ğŸš€ Running new Docker container..."
          docker run -d --name dependency-scan-container \
            -p 5000:5000 \
            --env-file .env \
            dependency-scan-app

          echo "âœ… Deployment complete! App running on port 5000"
        EOF